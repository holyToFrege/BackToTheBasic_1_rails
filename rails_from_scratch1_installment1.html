<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<!-- 2021-12-01 Wed 15:02 -->
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>rails from scratch</title>
<meta name="generator" content="Org mode" />
<meta name="author" content="Holy Frege" />
<meta name="description" content="Org-HTML export made simple."
 />
<meta name="keywords" content="org-mode, export, html, theme, style, css, js, bigblow" />
<style type="text/css">
 <!--/*--><![CDATA[/*><!--*/
  .title  { text-align: center;
             margin-bottom: .2em; }
  .subtitle { text-align: center;
              font-size: medium;
              font-weight: bold;
              margin-top:0; }
  .todo   { font-family: monospace; color: red; }
  .done   { font-family: monospace; color: green; }
  .priority { font-family: monospace; color: orange; }
  .tag    { background-color: #eee; font-family: monospace;
            padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .org-right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .org-left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .org-center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #ccc;
    box-shadow: 3px 3px 3px #eee;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: auto;
    padding-top: 1.2em;
  }
  pre.src:before {
    display: none;
    position: absolute;
    background-color: white;
    top: -10px;
    right: 10px;
    padding: 3px;
    border: 1px solid black;
  }
  pre.src:hover:before { display: inline; margin-top: 14px;}
  /* Languages per Org manual */
  pre.src-asymptote:before { content: 'Asymptote'; }
  pre.src-awk:before { content: 'Awk'; }
  pre.src-C:before { content: 'C'; }
  /* pre.src-C++ doesn't work in CSS */
  pre.src-clojure:before { content: 'Clojure'; }
  pre.src-css:before { content: 'CSS'; }
  pre.src-D:before { content: 'D'; }
  pre.src-ditaa:before { content: 'ditaa'; }
  pre.src-dot:before { content: 'Graphviz'; }
  pre.src-calc:before { content: 'Emacs Calc'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-fortran:before { content: 'Fortran'; }
  pre.src-gnuplot:before { content: 'gnuplot'; }
  pre.src-haskell:before { content: 'Haskell'; }
  pre.src-hledger:before { content: 'hledger'; }
  pre.src-java:before { content: 'Java'; }
  pre.src-js:before { content: 'Javascript'; }
  pre.src-latex:before { content: 'LaTeX'; }
  pre.src-ledger:before { content: 'Ledger'; }
  pre.src-lisp:before { content: 'Lisp'; }
  pre.src-lilypond:before { content: 'Lilypond'; }
  pre.src-lua:before { content: 'Lua'; }
  pre.src-matlab:before { content: 'MATLAB'; }
  pre.src-mscgen:before { content: 'Mscgen'; }
  pre.src-ocaml:before { content: 'Objective Caml'; }
  pre.src-octave:before { content: 'Octave'; }
  pre.src-org:before { content: 'Org mode'; }
  pre.src-oz:before { content: 'OZ'; }
  pre.src-plantuml:before { content: 'Plantuml'; }
  pre.src-processing:before { content: 'Processing.js'; }
  pre.src-python:before { content: 'Python'; }
  pre.src-R:before { content: 'R'; }
  pre.src-ruby:before { content: 'Ruby'; }
  pre.src-sass:before { content: 'Sass'; }
  pre.src-scheme:before { content: 'Scheme'; }
  pre.src-screen:before { content: 'Gnu Screen'; }
  pre.src-sed:before { content: 'Sed'; }
  pre.src-sh:before { content: 'shell'; }
  pre.src-sql:before { content: 'SQL'; }
  pre.src-sqlite:before { content: 'SQLite'; }
  /* additional languages in org.el's org-babel-load-languages alist */
  pre.src-forth:before { content: 'Forth'; }
  pre.src-io:before { content: 'IO'; }
  pre.src-J:before { content: 'J'; }
  pre.src-makefile:before { content: 'Makefile'; }
  pre.src-maxima:before { content: 'Maxima'; }
  pre.src-perl:before { content: 'Perl'; }
  pre.src-picolisp:before { content: 'Pico Lisp'; }
  pre.src-scala:before { content: 'Scala'; }
  pre.src-shell:before { content: 'Shell Script'; }
  pre.src-ebnf2ps:before { content: 'ebfn2ps'; }
  /* additional language identifiers per "defun org-babel-execute"
       in ob-*.el */
  pre.src-cpp:before  { content: 'C++'; }
  pre.src-abc:before  { content: 'ABC'; }
  pre.src-coq:before  { content: 'Coq'; }
  pre.src-groovy:before  { content: 'Groovy'; }
  /* additional language identifiers from org-babel-shell-names in
     ob-shell.el: ob-shell is the only babel language using a lambda to put
     the execution function name together. */
  pre.src-bash:before  { content: 'bash'; }
  pre.src-csh:before  { content: 'csh'; }
  pre.src-ash:before  { content: 'ash'; }
  pre.src-dash:before  { content: 'dash'; }
  pre.src-ksh:before  { content: 'ksh'; }
  pre.src-mksh:before  { content: 'mksh'; }
  pre.src-posh:before  { content: 'posh'; }
  /* Additional Emacs modes also supported by the LaTeX listings package */
  pre.src-ada:before { content: 'Ada'; }
  pre.src-asm:before { content: 'Assembler'; }
  pre.src-caml:before { content: 'Caml'; }
  pre.src-delphi:before { content: 'Delphi'; }
  pre.src-html:before { content: 'HTML'; }
  pre.src-idl:before { content: 'IDL'; }
  pre.src-mercury:before { content: 'Mercury'; }
  pre.src-metapost:before { content: 'MetaPost'; }
  pre.src-modula-2:before { content: 'Modula-2'; }
  pre.src-pascal:before { content: 'Pascal'; }
  pre.src-ps:before { content: 'PostScript'; }
  pre.src-prolog:before { content: 'Prolog'; }
  pre.src-simula:before { content: 'Simula'; }
  pre.src-tcl:before { content: 'tcl'; }
  pre.src-tex:before { content: 'TeX'; }
  pre.src-plain-tex:before { content: 'Plain TeX'; }
  pre.src-verilog:before { content: 'Verilog'; }
  pre.src-vhdl:before { content: 'VHDL'; }
  pre.src-xml:before { content: 'XML'; }
  pre.src-nxml:before { content: 'XML'; }
  /* add a generic configuration mode; LaTeX export needs an additional
     (add-to-list 'org-latex-listings-langs '(conf " ")) in .emacs */
  pre.src-conf:before { content: 'Configuration File'; }

  table { border-collapse:collapse; }
  caption.t-above { caption-side: top; }
  caption.t-bottom { caption-side: bottom; }
  td, th { vertical-align:top;  }
  th.org-right  { text-align: center;  }
  th.org-left   { text-align: center;   }
  th.org-center { text-align: center; }
  td.org-right  { text-align: right;  }
  td.org-left   { text-align: left;   }
  td.org-center { text-align: center; }
  dt { font-weight: bold; }
  .footpara { display: inline; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .equation-container {
    display: table;
    text-align: center;
    width: 100%;
  }
  .equation {
    vertical-align: middle;
  }
  .equation-label {
    display: table-cell;
    text-align: right;
    vertical-align: middle;
  }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  .org-svg { width: 90%; }
  /*]]>*/-->
</style>
<link rel="stylesheet" type="text/css" href="https://fniessen.github.io/org-html-themes/src/readtheorg_theme/css/htmlize.css"/>
<link rel="stylesheet" type="text/css" href="https://fniessen.github.io/org-html-themes/src/readtheorg_theme/css/readtheorg.css"/>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/js/bootstrap.min.js"></script>
<script type="text/javascript" src="https://fniessen.github.io/org-html-themes/src/lib/js/jquery.stickytableheaders.min.js"></script>
<script type="text/javascript" src="https://fniessen.github.io/org-html-themes/src/readtheorg_theme/js/readtheorg.js"></script>
<script type="text/javascript">
// @license magnet:?xt=urn:btih:e95b018ef3580986a04669f1b5879592219e2a7a&dn=public-domain.txt Public Domain
<!--/*--><![CDATA[/*><!--*/
     function CodeHighlightOn(elem, id)
     {
       var target = document.getElementById(id);
       if(null != target) {
         elem.classList.add("code-highlighted");
         target.classList.add("code-highlighted");
       }
     }
     function CodeHighlightOff(elem, id)
     {
       var target = document.getElementById(id);
       if(null != target) {
         elem.classList.remove("code-highlighted");
         target.classList.remove("code-highlighted");
       }
     }
    /*]]>*///-->
// @license-end
</script>
</head>
<body>
<div id="content">
<h1 class="title">rails from scratch</h1>
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#org211f90e">1. 맨 처음 해야 하는것(1. Local 개발환경 만들기)</a>
<ul>
<li><a href="#org3844f57">1.1. local 개발환경</a>
<ul>
<li><a href="#orga636631">ruby 설치(with rbenv)</a></li>
<li><a href="#org239955f">git 설치와 설정</a></li>
<li><a href="#orgce6e154">rails 설치</a></li>
<li><a href="#org1b6b91e">Database 설치</a></li>
<li><a href="#org5cb75aa">nokogiri, pg를 위한 설치</a></li>
<li><a href="#orge7ae448">rails server</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#orgc29897f">2. Production Server 설치</a></li>
<li><a href="#orga0df421">3. webapp 다시 만들기(Local server와 production을 위한 capistrano가 설치된 상황에서)</a>
<ul>
<li><a href="#orgb80b812">3.1. github에 project를 만든다.</a></li>
<li><a href="#org6d01786">3.2. rails new webapp</a></li>
<li><a href="#org959b84b">3.3. git push로 github에 반영</a></li>
<li><a href="#org3d77af1">3.4. capistrano gem설치</a></li>
<li><a href="#orgc27fa12">3.5. capistrano가 github과 aws와 db 접속할 수 있는지 미리 확인한다.</a>
<ul>
<li><a href="#orge82eabd">(1) github 연결가능 확인</a></li>
<li><a href="#org28cb160">(2) config/deploy.rb 설정- github settings (capistrano는 config/deploy.rb를 참고한다.)</a></li>
<li><a href="#orgd8233d5">(3) config/deploy/production.rb설정 -aws와 db환경 설정(config/deploy/production.rb)</a></li>
<li><a href="#org0b87fad">(4) password check-git과 aws의 password?</a></li>
<li><a href="#orgbd9ec59">(5) cap production deploy - cd config, cap production deploy</a></li>
<li><a href="#org2913cd2">(6) capistrano 추가작업- capfile에 추가작업 추가</a>
<ul>
<li><a href="#org68465b2">(6-1) Capfiles에 추가 작업</a></li>
<li><a href="#orgf7721f5">(6-2) bundle lock &#x2013;add-platform x86<sub>64</sub>-linux</a></li>
<li><a href="#orgaa3ba64">(6-3) .rbenv-vars에 master key와 secret base설정</a></li>
</ul>
</li>
<li><a href="#org1d62708">(7) [DB] 관련 설정</a>
<ul>
<li><a href="#org66d7079">[1] gem mysql2를 Gemfile에 추가.</a></li>
<li><a href="#org0ab8b49">[2] database.yml처리 (local 처리)</a></li>
<li><a href="#orge71626e">[3] .rbenv-vars변수 처리</a></li>
</ul>
</li>
<li><a href="#orgdb79c0b">(8) [WEB &amp; APP] nginx서버와 passenger를 키고 새로만든 rails app을 연동시키려면?</a>
<ul>
<li><a href="#org6d3006d">(1) nginx에서 수행할 rails app지정</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><a href="#org9f82f47">4. client의 database.yml설정 (development)</a></li>
<li><a href="#org263273b">5. 서버에 관해서 - testing</a>
<ul>
<li><a href="#org8d3528c">5.1. nginx 기본 및 test</a></li>
<li><a href="#org3560873">5.2. nginx + passenger</a>
<ul>
<li><a href="#org3e41547">(8) web 관련 설정</a>
<ul>
<li><a href="#org96ea421"><i>etc/nginx/conf.d</i> - passenger설정</a></li>
<li><a href="#orgd09a5ec">/site-enabled/config - nginx 설정</a></li>
</ul>
</li>
<li><a href="#org9fce9e0">error처리 모음.</a>
<ul>
<li><a href="#org63de0b6">nginx가 start되지 않고, passenger관련 에러 (/var/log폴더 삭제시)</a></li>
<li><a href="#orgaea65df">bundle에서 에러</a></li>
<li><a href="#orge72cc18">DB관련 권한 문제</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><a href="#orgff5079e">6. log에 관해서</a>
<ul>
<li><a href="#orgb86700f">6.1. rails log</a></li>
<li><a href="#orgf8c11e2">6.2. nginx &amp; passenger log</a></li>
</ul>
</li>
</ul>
</div>
</div>

<div id="outline-container-org211f90e" class="outline-2">
<h2 id="org211f90e"><span class="section-number-2">1</span> 맨 처음 해야 하는것(1. Local 개발환경 만들기)</h2>
<div class="outline-text-2" id="text-1">
<div class="note" id="org17af3c2">
<p>
local에서 작업할수 있는 환경을  만든다. gorails에서 지시하는대로 한다. 그 다음 capistrano를 통해 운영서버에 적용하는 환경을 만들것이다. 두 환경은 하나의 rails project에서 동시에 운영된다. 아무 문제 없다. 즉 capistrano 설정을 하면 local에서 작업하지 못하고, local에서 별도로 rails new railsproject를 사용해서 local용을 만들 필요가 없다는 것이다. 하나의 rails 프로젝트에서 test하고 rails s로 local test하고 제대로 되면 운영서버로 배포하는 형태를 가지면 된다.
</p>

</div>
</div>
<div id="outline-container-org3844f57" class="outline-3">
<h3 id="org3844f57"><span class="section-number-3">1.1</span> local 개발환경</h3>
<div class="outline-text-3" id="text-1-1">
</div>
<div id="outline-container-orga636631" class="outline-4">
<h4 id="orga636631">ruby 설치(with rbenv)</h4>
<div class="outline-text-4" id="text-orga636631">
<div class="note" id="org7351a7b">
<p>
rails는 ruby version을 탄다. rails와 ruby version이 궁합이 맞아야 하고, gem들도 맞아야 한다. ruby설치는 rbenv를 사용한다.
</p>

</div>
<div class="note" id="org90c831e">
<p>
rbenv는 여러버전의 ruby를 설치할 수 있는데, 이것이 가능한것은 ruby-build라는 plugin이 있기에 가능하다. rbenv install 3.14 이런식으로 ruby를 설치하는것은 rbenv-build에 있는 rbenv-install에 의해서 가능한 것이다. pyenv도 동일한 형식이다.
</p>

</div>

<div class="tip" id="org681a08c">
<p>
brew install rbenv ruby-build
</p>

<p>
echo 'if which rbenv &gt; <i>dev/null; then eval "$(rbenv init -)"; fi' &gt;&gt; ~</i>.zshrc
source ~/.zshrc
</p>

<p>
rbenv install 3.0.1
rbenv global 3.0.1
ruby -v
</p>

</div>
</div>
</div>
<div id="outline-container-org239955f" class="outline-4">
<h4 id="org239955f">git 설치와 설정</h4>
<div class="outline-text-4" id="text-org239955f">
<div class="note" id="orgc1f2298">
<p>
rails는 기본적으로 git init의 과정으로 local git을 설정한다. 그래서 git이 이미 system에 설치되어 있어야 하고, git에 대한 설정을 해야 한다. 그리고 github에 저장해야 하기 때문에, ssh도 만들어야 한다.
</p>

</div>
<div class="tip" id="org281f210">
<p>
git config &#x2013;global color.ui true
git config &#x2013;global user.name "holy"
git config &#x2013;global user.email "holy@fastmail.com"
ssh-keygen만 해도 된다.
</p>

</div>
</div>
</div>
<div id="outline-container-orgce6e154" class="outline-4">
<h4 id="orgce6e154">rails 설치</h4>
<div class="outline-text-4" id="text-orgce6e154">
<div class="note" id="orgbabc550">
<p>
gem은 ruby를 설치하면 자동으로 같이 설치된다. gem을 이용해서 rails를 설치한다.
gem install rails -v 6.1.3.2 
</p>

</div>
<div class="note" id="org64fcca5">
<p>
한가지 특이한건, gem으로 설치한 rails를 사용하기 위해선 rbenv에게
rails가 설치되었다는 것을 알려줘야 한다는 것이다.
</p>

</div>
<div class="tip" id="org39895d1">
<p>
rbenv rehash를 해야만 rails를 사용할 수 있다.
</p>

</div>
</div>
</div>
<div id="outline-container-org1b6b91e" class="outline-4">
<h4 id="org1b6b91e">Database 설치</h4>
<div class="outline-text-4" id="text-org1b6b91e">
<div class="note" id="org22d8994">
<p>
brew install mysql
brew services start mysql
</p>

</div>
</div>
</div>
<div id="outline-container-org5cb75aa" class="outline-4">
<h4 id="org5cb75aa">nokogiri, pg를 위한 설치</h4>
<div class="outline-text-4" id="text-org5cb75aa">
<div class="note" id="org1bfb13d">
<p>
원래는 다음을 실행해야 하는데, 설치가 제대로 안된다.
-&#x2014;다음-&#x2014;
sudo installer -pkg /Library/Developer/CommandLineTools/Packages/macOS<sub>SDK</sub><sub>headers</sub><sub>for</sub><sub>macOS</sub><sub>10.14.pkg</sub> -target /
</p>

<p>
아래를 설치한다.
brew install libxml2 libxslt
gem install nokogiri &#x2013;platform=ruby &#x2013; &#x2013;use-system-libraries
</p>

</div>
</div>
</div>
<div id="outline-container-orge7ae448" class="outline-4">
<h4 id="orge7ae448">rails server</h4>
<div class="outline-text-4" id="text-orge7ae448">
<div class="note" id="org08c9fec">
<p>
rails new mysite &#x2013;database=mysql
rails db:setup
rails db:migrate
rails s
</p>

</div>
</div>
</div>
</div>
</div>
<div id="outline-container-orgc29897f" class="outline-2">
<h2 id="orgc29897f"><span class="section-number-2">2</span> Production Server 설치</h2>
</div>
<div id="outline-container-orga0df421" class="outline-2">
<h2 id="orga0df421"><span class="section-number-2">3</span> webapp 다시 만들기(Local server와 production을 위한 capistrano가 설치된 상황에서)</h2>
<div class="outline-text-2" id="text-3">
</div>
<div id="outline-container-orgb80b812" class="outline-3">
<h3 id="orgb80b812"><span class="section-number-3">3.1</span> github에 project를 만든다.</h3>
</div>
<div id="outline-container-org6d01786" class="outline-3">
<h3 id="org6d01786"><span class="section-number-3">3.2</span> rails new webapp</h3>
</div>
<div id="outline-container-org959b84b" class="outline-3">
<h3 id="org959b84b"><span class="section-number-3">3.3</span> git push로 github에 반영</h3>
</div>
<div id="outline-container-org3d77af1" class="outline-3">
<h3 id="org3d77af1"><span class="section-number-3">3.4</span> capistrano gem설치</h3>
<div class="outline-text-3" id="text-3-4">
<div class="note" id="org0c3b5b1">
<p>
project를 새로 만들었기 때문에 capistrano gem이 설치가 안되어 있을 것이다. capistrano를 설치해야만 deploy.rb와 deploy폴더가 만들어지고, 거기에서 github과 server에 대한 설정을 할 수 있다. capistrano는 배포 tool이다. 배포라는 것은 특정한 곳에 있는 sw를 다른 곳으로 이동하는 배치하는 작업을 뜻한다. 아래에 나오겠지만, STAGES에 배치가될 computer를 설정하게 된다. 해당 sw를 STAGES에 정의된 computer로 이동하는 것을 배포(deploy)라고 할 수 있다. 우리가 옮기게 될 source는 web app이다. rails new 해서 만드는 webapp이다. 이 source를 만든 후에 우리는 rake db:migrate라고 해서, db관련 처리를 하고, rails s를 통해서 server를 실행한다. 이 과정을 원격에 있는 server에서 할 수 있게 한다고 보면 된다. 여기서 하나 가정하고 있는 것은 source는 github에 있다고 보면 된다. 즉 정리하면, capistrano같은 배포 툴이 하는 일은, local에서  github으로 연결해서 source를 가져와서 server의 특정위치에 넣는다. 이렇게 하기 위해 알아야 하는 것은 github의 주소, branch, 인증관련처리, server주소, server의 특정위치를 미리 설정해야 하는 것이다. 그런 다음 server에 접속해서 server에서 마치 local에서 rake db:migrate하듯이 db처리를 하고, rails s로 puma라는 was를 실행하고, spring이라는 webserver를 실행 시키는 것과 비슷한 작업을 한다. 그래서 NGinx라는 web server를 실행하거나 끄고, Passenger란 WAS를 실행하거나 끌 수 있다. 이렇게 하기 위해서는 webserver주소, WAS 주소, DB주소 등을 알아야 한다. 이 모든 것을 cap에서 설정한다.
</p>

</div>
<p>
아래의 gem을 Gemfile에 설정한다.
</p>
<div class="tip" id="org9aee2be">
<p>
gem 'capistrano', '~&gt; 3.11'
gem 'capistrano-rails', '~&gt; 1.4'
gem 'capistrano-passenger', '~&gt; 0.2.0'
gem 'capistrano-rbenv', '~&gt; 2.1', '&gt;= 2.1.4'
</p>

</div>

<ul class="org-ul">
<li>bundle 실행
bundle은 Gemfile의 gem을 <i>Users/holy</i>.rbenv/versions/3.0.1/lib/ruby/gems/3.0.0/gems에 설치한다.</li>

<li><p>
cap install STAGES=production 실행
cap install을 하면 해당 project를 배포하기 위한 설정파일과 task들이 만들어 진다. 배포를 위한 준비를 하는 과정이라고 보면 된다. 배포 관련 설정들, 즉 설정 변수를 설정하는 것은 현재 위 명령어에는  depoly.rb와 production.rb파일이 만들어지고 여기에서 하게 된다. 만일 위 명령어를 cap install STAGES= production temp라고 하면 3개의 설정파일이 만들어지게 된다. deploy.rb, production.rb, temp.rb라는 3개의 파일이 만들어진다. STAGES라는 용어는 배포가 될 서버를 의미한다. 즉 production이라는 server를 가지고 있고, 여기에 배포를 하겠다는 의미다. temp도 server가 되고, 여기에도 배포를 한다. server들에 배포를 할 때 공통적인것은 config/deploy.rb에 설정을 하고, server에 해당하는 것은 server.rb라는 파일에 기술하는 것이다. 위 설정파일들은 변수에 값을 넣는 설정뿐이다.  실제 task들이 이렇게 설정된 값을 이용할 뿐이다. 그러면 실제 task들은 어디에 기술되어 있는가? capistrano가 해야 하는 것은 Capfile에 기술되어 있다. 배포를 시작하는 명령어가 cap인데,  cap을 하면 Capfile을 실행한다고 보면 된다. Capfile에서는 deploy.rb와 production.rb를 load한다. 
</p>

<p>
cap install로 만들어지는 것은 다음과 같다.
</p>
<ol class="org-ol">
<li>config/deploy.rb</li>
<li>config/deploy/production.rb</li>
<li>lib/capistrano/tasks</li>
<li>Capfiles</li>
</ol></li>
</ul>
<div class="note" id="org213c6d3">
<p>
bundle
cap install STAGES=production
</p>

</div>
<div class="note" id="org2e6a1d6">
<p>
그리고 위에서 대략적으로 살펴보았지만, capistrano가 하는 일은 크게 2가지로 나눠서 볼 수도 있다. 첫번째로 github에 있는 source인 webapp을 ec2에 옮기는 일&#x2026;.여기서는 github 주소와 ec2에서 배치될 위치, github ssh인증, ec2 ssh인증&#x2026;과 같은 정보가 필요하다. 두번째로,  옮겨진 source에 대해서 db:migrate를 통해서 db처리, nginx를 다시 껏다 키고, passenger도 껏다 키는 기능으로 볼 수 있다. 여기서는 db정보, nginx서버정보, passenger서버정보가 필요하다.
이것을 2개의 설정파일로 나눠서 처리할 수도 있다
. github에서 ece2쪽으로 source를 이동하는 작업은 보편적인 작업이기 때문에 deploy.rb에서 처리하고, server에서 db를 연결하고, server를 다시 껏다 키는 task는 server에 한정되는 기능이기 때문에 production.rb에서 처리할 수 있다.
</p>

</div>
</div>
</div>
<div id="outline-container-orgc27fa12" class="outline-3">
<h3 id="orgc27fa12"><span class="section-number-3">3.5</span> capistrano가 github과 aws와 db 접속할 수 있는지 미리 확인한다.</h3>
<div class="outline-text-3" id="text-3-5">
</div>
<div id="outline-container-orge82eabd" class="outline-4">
<h4 id="orge82eabd">(1) github 연결가능 확인</h4>
<div class="outline-text-4" id="text-orge82eabd">
<div class="note" id="orgb24945d">
<ol class="org-ol">
<li>keychain을 실행해서 github.com을 찾는다. id와 pw가 github의 id와 pw와 같은지 확인한다. 동일하지 않다면 동일하게 해준다. 2021.8월 부터 github의 password는 token값으로 변경되었다. 이것이 처리되어 있어야 한다. 아래는 ssh인증을 통해서 접근 가능여부만 테스트한다.</li>
</ol>

</div>
<blockquote>
<p>
ssh -T git@github.com
</p>
</blockquote>

<div id="org7bf92c8" class="figure">
<p><img src="./img/githubTest.png" alt="githubTest.png" width="800px" />
</p>
<p><span class="figure-number">Figure 1: </span>github test</p>
</div>
</div>
</div>

<div id="outline-container-org28cb160" class="outline-4">
<h4 id="org28cb160">(2) config/deploy.rb 설정- github settings (capistrano는 config/deploy.rb를 참고한다.)</h4>
<div class="outline-text-4" id="text-org28cb160">
<div class="note" id="org0a733b3">
<p>
위에서도 얘기했듯이, deploy.rb는 github의 source를 ec2의 특정위치로 복사하는 역할이다. 여기에는 github, branch 같은 정보와 ec2의 위치정보, 인증에 관한 정보가 필요하다.
</p>

</div>

<div id="org7b507b4" class="figure">
<p><img src="./img/deploy1.png" alt="deploy1.png" width="800px" />
</p>
<p><span class="figure-number">Figure 2: </span>deploy.rb</p>
</div>

<div class="note" id="org8acbef1">
<p>
deploy.rb는 github에 있는 source를 server의 특정위치로 복사하는 역할이다. 이때 필요한것은 github의 source의 위치를 나타내는 repo<sub>url과</sub> branch이름이 필요하다. 또한 server의 주소와 저장될 위치를 기술해야 하는데, server의 위치정보는 production.rb에 기술하기 때문에, 여기서는 github의 source를 가져가서 어떤 위치에 놓을까하는 application과 deploy<sub>to만</sub> 기술하면 된다. 아래와 같은 정보가 되겠다.
</p>

<p>
application:  project이름.
repo<sub>url</sub>: 저장소 위치
branch: branch 이름
deploy<sub>to</sub> : deploy할 위치
</p>

<p>
아래에 보면 linked<sub>dirs와</sub> keep<sub>release라는게</sub> 붙었다. keep<sub>release는</sub> 5으로 설정되어 있다. 이것이 의미하는 것은 다음과 같다. 배포를 하면, 즉 cap production deploy라고 하면, capistrano가 github에서 source를 가져와서 repo<sub>to가</sub> 가르키는 위치에 release라는 폴더를 만들고, 거기에 저장한다. release폴더에 있는 source들의 개수를 의미한다. 가장 최근의 release는 current라는 이름의 폴더로 link연결 된다. 5는 5개의 release를 유지하겠다는 뜻이다. 즉, 5개만 최신본을 유지한다. 그래서 rollback도 가능하다. linked<sub>files와</sub> linked<sub>dirs는</sub> 정확히 모르겠다. 
</p>

</div>

<div class="note" id="orgf00042d">
<p>
set :application, "myapp"  =&gt; project app이름
set :repo<sub>url</sub>, "git@github.com:PnC-jeju/myapp.git"  =&gt; github위치
set :branch, "main" =&gt; 배포할려는 branch
set :deploy<sub>to</sub>, "/home/deploy/#{fetch :application}" =&gt; 배포 위치
append :linked<sub>dirs</sub>, 'log', 'tmp/pids', 'tmp/cache', 'tmp/sockets', 'vendor/bundle', '.bundle', 'public/system', 'public/uploads'
set :keep<sub>releases</sub>, 5
</p>

</div>
</div>
</div>
<div id="outline-container-orgd8233d5" class="outline-4">
<h4 id="orgd8233d5">(3) config/deploy/production.rb설정 -aws와 db환경 설정(config/deploy/production.rb)</h4>
<div class="outline-text-4" id="text-orgd8233d5">
<div class="note" id="org7c45e72">
<p>
production.rb의 설정은 단순하다. production.rb는 webserver, WAS서버, DB에 관련된 task를 하기위한 변수 설정을 기술한다. 단순하게 여기에선
아래처럼 server의 위치와 capistrano가 배포에 사용할 계정을 기술할 뿐이다. role에 관한 설명을 하자면, 우리는 STAGES에 하나의 server만 설정했다. 일반적으로 여러개의 server를 설정할 수 있다. app server, web server, db server등&#x2026;각각의 역할이 있는 server 들이다. 또한 test server, release server등 여러가지로 만들 수도 있다. 각각의 역할이 있는 server들의 경우, server에 따른 role을 정해준다. 예를 들어서 web server의 경우, capistrano에서 webserver는 web이란 role을 부여해주고, db server는 capistrano에서 db라는 role을 정해주면  그것에 맞는 task가 수행되는 것이다. 우리는 하나의 server, production이란 server를 사용하기 때문에, app,db,web의 3개의 role을 주면 된다.
</p>

<p>
그런데, 조금 이상하지 않나? production에서 하는 일은, bundler를 실행해서 gem들을 설치한 후 rake db:migrate로  db연결하고 rails s로 server를 동작 시키듯이 app,web server를 동작 시켜야 한다. 그런데, 이런 과정을 하기위한 설정은 아래와 같이 단순하다. 물론 그럴 수 있다. task에서 다 정의 되어 있으니, 그래서 cap production deploy하면 config/deploy.rb에서 설정한 값과 production.rb에서 정의한 ip주소를 바탕으로 github에서 source를 이동 시킨다. 하지만, 실제 서버를 재시작하거나 bundler를 실행시킨다거나 하는 작업은 log에서도 안보이고 실제 server에서도 동작하지 않는다. 이것은 실제 task를 실행하는 Capfile 설정이 안되었기 때문이다. Capfile에서 ruby에 대한 설정, web과 app에 대한 기술을 해줘야 그에 맞는 task가 동작하기 때문이다. 현재는 capistrano/setup을 통해서 config/deploy.rb와 production.rb를 load하고 capistrano/scm/git을 통해서 source이동만을 처리한다. web,app,db, ruby,bundler에 대한 처리를 하기위해선  capfile에 추가적인 작업을 해줘야 한다. 이것은 (5)에서 다시 중첩해서 설명을 할 것이다.
</p>

</div>

<div class="note" id="org4584309">
<p>
server "13.125.158.130", user: "deploy", roles: %w{app db web}
</p>

</div>
</div>
</div>
<div id="outline-container-org0b87fad" class="outline-4">
<h4 id="org0b87fad">(4) password check-git과 aws의 password?</h4>
<div class="outline-text-4" id="text-org0b87fad">
<div class="note" id="org392bf9d">
<p>
git과 aws에 접속하기 위해서 password가 필요하다. 이것을 하기 위해선 다음과 같은 작업이 필요하다.
</p>

</div>
<div class="tip" id="org411bc68">
<p>
ssh-add ~/.ssh/company-ec2-keys.pem
ssh-add ~/.ssh/id<sub>rsa</sub>
</p>

</div>
</div>
</div>
<div id="outline-container-orgbd9ec59" class="outline-4">
<h4 id="orgbd9ec59">(5) cap production deploy - cd config, cap production deploy</h4>
<div class="outline-text-4" id="text-orgbd9ec59">
<div class="note" id="org198b89c">
<p>
이렇게 하고 cap production deploy를 해보자. 동작은 되고 아무 문제도 없지만, server가 재시작 된다거나, bundler가 실행되거나 하는 정황이 보이지 않는다. 이것은 capfile에서 config/deploy.rb, production.rb를 load하고 scm/git으로 git에 있는 source를 server에 이동만 했기 때문이다. 옮겨진 source에 bundler를 사용해서 gem을 설치하고, db migration을 하고 web server와 app server를 실행 하는것은 Capfile에 기술되어야 한다.
</p>

</div>
</div>
</div>
<div id="outline-container-org2913cd2" class="outline-4">
<h4 id="org2913cd2">(6) capistrano 추가작업- capfile에 추가작업 추가</h4>
<div class="outline-text-4" id="text-org2913cd2">
</div>
<div id="outline-container-org68465b2" class="outline-5">
<h5 id="org68465b2">(6-1) Capfiles에 추가 작업</h5>
<div class="outline-text-5" id="text-org68465b2">
<p>
Capfile끝에 아래를 추가한다.  이 작업들은 db와 web server와 관련이 있다. 그래서 바로 cap production deploy를 실행하면 에러가 발생한다. web과 db설정이 추가로 들어간다.
</p>
<div class="tip" id="orgea65778">
<p>
require 'capistrano/rails'
require 'capistrano/passenger'
require 'capistrano/rbenv'
</p>

<p>
set :rbenv<sub>type</sub>, :user
set :rbenv<sub>ruby</sub>, '3.0.1'
</p>

</div>
</div>
</div>
<div id="outline-container-orgf7721f5" class="outline-5">
<h5 id="orgf7721f5">(6-2) bundle lock &#x2013;add-platform x86<sub>64</sub>-linux</h5>
<div class="outline-text-5" id="text-orgf7721f5">
<div class="note" id="org70f1674">
<p>
Your bundle only supports platforms ["x86<sub>64</sub>-darwin-19"] but your local platform is x86<sub>64</sub>-linux. Add the current platform to the lockfile with 'bundle lock &#x2013;add-platform x86<sub>64</sub>-linux' and try again.
</p>

</div>
<p>
capistrano추가작업은  server에 접속해서 bundler를 실행하는데, Gemfiles.lock에 server platform이 기술 안되어 있기 때문에 에러가 난다. 그래서 미리 다음과 같은 명령으로 Gemfile.lock 추가하자. Gemfile.lock은 ec2 server에서 bundler가 실행할 gem file목록이다. 그래서 github에 push를 해줘야 server에서 사용할 수 있기 때문에 github에 commit과 push를 해줘야 한다.
</p>

<p>
이제 모든 설정이 다 끝났구나하고 cap production deploy하면 어떻게 될까? bundler를 실행중에 에러가 발생한다. 왜 발생하는지는 모르겠다. 인터넷을 찾아보니 공간 부족때문이라고 한다. gem을 설치할 공간이 없기 때문이란다. 우선 쓰잘대기 없는거 지우고 다시 cap production deploy를 해본다. hang out이 걸린다. 아무런 진전 없이 bundler:install에서 계속 멈춰 있다.  다시 ec2를 중지하고 다시 시작한후 최대한 지울꺼 지워서 용량을 확보한 후에 다시 cap production deploy하니  bundler:install 단계는 지나갔다. 대신 assets:precompile에서 secret<sub>key</sub><sub>base문제로</sub> 에러가 발생했다. 아래에 image는 추가했다. secret<sub>key문제는</sub> 아래에 해결 방법이 있다.
</p>
<div class="tip" id="org9db4156">
<p>
bundle lock &#x2013;add-platform x86<sub>64</sub>-linux
</p>

</div>

<div id="orgf424d88" class="figure">
<p><img src="./img/bundlererror.png" alt="bundlererror.png" width="800px" />
</p>
<p><span class="figure-number">Figure 3: </span>bundler error</p>
</div>


<div id="org421c82e" class="figure">
<p><img src="./img/deployerror2.png" alt="deployerror2.png" width="800px" />
</p>
<p><span class="figure-number">Figure 4: </span>bundler error2</p>
</div>
</div>
</div>

<div id="outline-container-orgaa3ba64" class="outline-5">
<h5 id="orgaa3ba64">(6-3) .rbenv-vars에 master key와 secret base설정</h5>
<div class="outline-text-5" id="text-orgaa3ba64">

<div id="org14ef672" class="figure">
<p><img src="./img/rbenv_settings.png" alt="rbenv_settings.png" width="800px" />
</p>
<p><span class="figure-number">Figure 5: </span>rbenv 설정</p>
</div>
<div class="note" id="orgcfbe7ec">
<ul class="org-ul">
<li>server에 ssh연결을 한다. project폴더 아래에 .rbenv-vars라는 파일을 만든다. 위의 그림처럼 setting하면 된다.</li>
<li>[DATABASE<sub>URL</sub>]은 위에 좀 햇갈리는데, 그냥 아래와 같은 규칙이 있다고 생각하면 편하다.
DATABASE<sub>URL</sub>=mysql2://&lt;username&gt;:&lt;password&gt;@localhost/&lt;database&gt; 이거에 맞게 써주면 된다.</li>
<li>[Rails<sub>Master</sub><sub>Key</sub>] local의   /config아래의 master<sub>key파일</sub> 내용을 서버의 .rbenv-vars에 복사한다.</li>
<li>[Secret<sub>Key</sub><sub>Base</sub>] local에서 secret<sub>key</sub><sub>base를</sub> 얻어야 하는데, 다음과 같이 한다.
local의 config폴더로 이동한다. shell에서 EDITOR=vim rails credentials:edit 입력한다.
secret<sub>key</sub><sub>base를</sub> 서버의 .rbenv-vars파일에 복사한다. 아래 그림을 참조한다.</li>
</ul>

</div>

<div id="orgf6ccc7c" class="figure">
<p><img src="./img/secret_key.png" alt="secret_key.png" width="800px" />
</p>
<p><span class="figure-number">Figure 6: </span>secret<sub>key</sub></p>
</div>
<div class="note" id="org833f734">
<p>
여기서 cap production deploy를 하면 어떻게 될까?
아래 그림처럼 rake db:migration에서 에러가 난다.  mysql2라는 gem이 없다는 것이다. 그러면 (7)에서 처리를 해줘야 한다.
</p>

</div>

<div id="orgb05ab1c" class="figure">
<p><img src="./img/dberror1.png" alt="dberror1.png" width="800px" />
</p>
<p><span class="figure-number">Figure 7: </span>db error</p>
</div>
</div>
</div>
</div>

<div id="outline-container-org1d62708" class="outline-4">
<h4 id="org1d62708">(7) [DB] 관련 설정</h4>
<div class="outline-text-4" id="text-org1d62708">
<div class="note" id="orgecd863c">
<ul class="org-ul">
<li>[1]Gemfiles에 mysql2 gem을 추가한다.</li>
<li>bundler를 실행한 후에, github에 commit push한다.</li>
<li>cap production deploy를 해본다.
=&gt; 이렇게 하면 에러없이, 별다른 문제 없이 deploy는 된다. 하지만, 제대로 된 db설정을 한 게 아니다. database.yml에서 구체적으로 production, development, test환경에서 우리가 사용하는 db를 기술해야 한다.</li>
<li>[2] database.yml에서 처리
production환경과 development, test환경 모두 mariadb를 사용할 것이기 때문에 공통적으로  mysql2 adapter를 사용한다. database명, userid,password,socket을 명시해야 한다. production에 해당하는 서버와 local에 해당하는 development에서 모두 해주어야 한다. 왜냐면, db server인  mariadb에 연결해야 하기 때문이다. database.yml을 작성하기 이전에  login을 할 수 있는 사용자와 기술한 database이름을 server나 local mariadb에 이미 만들어놔야 한다. 아래에서 더 자세히 설명.</li>

<li>[3] .rbenv-vars처리: 이전에 처리했지만, 다시 한번 작성한다.</li>
</ul>

</div>
</div>
<div id="outline-container-org66d7079" class="outline-5">
<h5 id="org66d7079">[1] gem mysql2를 Gemfile에 추가.</h5>
<div class="outline-text-5" id="text-org66d7079">

<div id="orgce9caa9" class="figure">
<p><img src="./img/mysql2.png" alt="mysql2.png" width="800px" />
</p>
<p><span class="figure-number">Figure 8: </span>mysql2</p>
</div>

<div class="note" id="org80e5ee9">
<p>
위와 같이 version을 잘 맞추어 넣어준 후에,  bundle, bundle update를 한다. 그 이후 git에 반영을 해야 한다.
</p>

</div>
</div>
</div>
<div id="outline-container-org0ab8b49" class="outline-5">
<h5 id="org0ab8b49">[2] database.yml처리 (local 처리)</h5>
<div class="outline-text-5" id="text-org0ab8b49">
<div class="note" id="orgb7c6407">
<p>
local과 server에는 이미 mariadb가 설정되었다고 가정한다.
database를 만들고, 이에 접근할 수 있는 사용자를 만들어야 한다. 또 권한도 주고&#x2026;local과 server는 동일하게 구성한다. 다만 차이는 있다. 우선 local에서 구성한다.
</p>
<ul class="org-ul">
<li>[database 만들기]
database이름은 rails new로 만든 web app이름과 같게 해준다. 다만 소문자로 만든다. local과 server동일하게 한다. 내 경우, smartwatercare라고 했다. 만드는 법은 다음과 같다.
<ol class="org-ol">
<li>local에서 root로 접근한다.
mysql -u root -p</li>
<li>local에서 db 만든다.
ex) CREATE DATABASE IF NOT EXISTS smartwatercare;</li>
</ol></li>
</ul>

</div>

<div id="org13432d1" class="figure">
<p><img src="./img/createdb.png" alt="createdb.png" width="400px" />
</p>
<p><span class="figure-number">Figure 9: </span>create db</p>
</div>
<div class="note" id="org4f183d1">
<ol class="org-ol">
<li>local에서 사용자 만들기
사용자는 deploy라는 계정을 만든다. capistrano가 db에 접근할 수 있어야 하기 때문이다. mysql이나 mariadb가 특이한게 있는데, 계정이 이름만으로 만들어지지 않는다는 것이다. email주소처럼 뒤에 host가 붙는다. 권한때문에 그렇다. 외부에서 접근하는 경우와 localhost에서 접근하는 경우 때문에 사용자 계정을 만들때 2개를 만들어야 한다. localhost와 %로 외부 host에서 접근하는 계정이다.
ex) CREATE USER IF NOT EXISTS 'deploy'@'localhost'  IDENTIFIED BY '1234';
ex) CREATE USER IF NOT EXISTS 'deploy'@'%' IDENTIFIED BY '1234';
그런데 여기서는 local에서만 적용되는 계정이라서, 2번째의 예는 사용하지 않는다.
<ol class="org-ol">
<li>사용자 확인
사용자가 미리 있을 수 있다. mariadb는 mysql db에 user라는 table에 사용자 정보가 있다. 확인해 보자.
ex) use mysql; select host,user,password,plugin from user</li>
</ol></li>
</ol>

</div>

<div id="orgc3947b1" class="figure">
<p><img src="./img/dbuser1.png" alt="dbuser1.png" width="800px" />
</p>
<p><span class="figure-number">Figure 10: </span>dbuser</p>
</div>
<div class="note" id="org50a47c3">
<p>
다행히 없다. 만일 있다면, drop user 사용자@ %로 지워야 한다. 따라서, 다음 명령어로 deploy@localhost라는 사용자를 만든다. 난 deploy는 pw를 주지 않았다.
CREATE USER IF NOT EXISTS 'deploy'@'localhost' ;
</p>

<p>
그리고 smartwatercare라는 db에 접근할 수 있는 모든 권한을 준다.
GRANT ALL PRIVILEGES ON myapp.* TO 'deploy'@'localhost';
</p>

<p>
이렇게 한 후에 FLUSH PRIVILEGES;를 해주는 것을 잊지말자.
</p>

</div>

<div id="org36f2c6c" class="figure">
<p><img src="./img/createuser1.png" alt="createuser1.png" width="800px" />
</p>
<p><span class="figure-number">Figure 11: </span>createuser</p>
</div>

<div class="note" id="org5a4ac48">
<ol class="org-ol">
<li>production server에서 사용자 만들기
production server는 사용자가 2명이다. capistrano가 사용하는 deploy사용자와 외부에서 접근하는 사용자가 있다.  deploy사용자와 외부 사용자는 모두 localhost와 외부에서도 사용하게 할 예정이기 때문에 2개의 계정을 만들면 된다. deploy와 webuser01이다.  난 이미 있기 때문에 생략했다. 참고로 deploy의 pw는 설정하지 않았다.  다만 권한 설정만 다시 해준다. 이렇게 해준다음에 database.yml을 설정해주면 된다.</li>
</ol>

</div>

<div id="org5f28ce7" class="figure">
<p><img src="./img/serveruser1.png" alt="serveruser1.png" width="800px" />
</p>
<p><span class="figure-number">Figure 12: </span>server user</p>
</div>

<div class="note" id="org6f1fa1c">
<ul class="org-ul">
<li>database.yml 설정</li>
</ul>
<p>
database의 기본 설정은 아래 그림을 참조하면 될듯 하다. 여기서 database는 실제는 참조되지 않는다. 왜냐면 .rbenv-vars라는 환경변수에서 database url에 database명을 기록했기 때문에 거기에 명시된 database명으로 capistrano는 접근한다. 그래서 어떻게 보면 database.yml에 기술하지 않아도 될듯하다.
</p>

<p>
나는 deploy의 pw를 설정하지 않았다. 그래서 password항목을 지웠다. 만일, password가 있는경우, 환경변수에 저장하고 불러다 쓰는 방식을 이용한다.
이렇게 하고 github에 저장한 이후 cap production deploy를 해보자.
</p>

</div>


<div id="org12e72f4" class="figure">
<p><img src="./img/database1.png" alt="database1.png" width="800px" />
</p>
<p><span class="figure-number">Figure 13: </span>database</p>
</div>



<div id="org987f778" class="figure">
<p><img src="./img/rbenvaras2.png" alt="rbenvaras2.png" width="800px" />
</p>
<p><span class="figure-number">Figure 14: </span>rbenvars2</p>
</div>
</div>
</div>

<div id="outline-container-orge71626e" class="outline-5">
<h5 id="orge71626e">[3] .rbenv-vars변수 처리</h5>
<div class="outline-text-5" id="text-orge71626e">
<div class="note" id="orgd537ced">
<p>
.rbenv-vars에서 database url을 기술하는데, 여기서 db명이 database.yml과 겹친다. 그런데 실제 capistrano가 사용하는 것은 환경변수의 database명이다. 그래서 rbenv-vars에서 사용하는 db명과 database.yml에 기술되는 db명을 일치 시키는게 중요하다.
</p>

</div>

<div id="orgf9f2e0a" class="figure">
<p><img src="./img/rbenvars.png" alt="rbenvars.png" width="800px" />
</p>
<p><span class="figure-number">Figure 15: </span>mysql3</p>
</div>
</div>
</div>
</div>


<div id="outline-container-orgdb79c0b" class="outline-4">
<h4 id="orgdb79c0b">(8) [WEB &amp; APP] nginx서버와 passenger를 키고 새로만든 rails app을 연동시키려면?</h4>
<div class="outline-text-4" id="text-orgdb79c0b">
<div class="note" id="org481d08f">
<p>
새로만든 rails app은 nginx웹서버와 passenger라는 app서버는 새로만든 rails app의 존재를 알지 못한다.  nginx-&gt;passenger-&gt;rails app을 호출하는 구조이기 때문에 nginx의 sites<sub>enabled폴더에</sub> 보면 설정파일이 있을것이다. 이 파일을 보면 server<sub>name이라는</sub> 항목에 rails app이름이 기술되어 있다. 새로만든 rails app이름으로 해주어야 한다. 그런데 nginx에서 site-enabled폴더 안에 있는 설정파일을 기술하는 방식은 좀 다르다. site-avaliable폴더를 보면 site-enabled폴더안의 파일이 있는 것을 볼 수 있다. symbolic link로 연결되어 있기 때문이다. 수정은 보통 site-available에 있는 설정파일을 수정한다. 자동으로 반영된다. 근데 이렇게 고전적인 방식으로 할 필요는 없다. 그냥 sites-enabled폴더에서 수정한다.
</p>
<ol class="org-ol">
<li>ssh로 server로 접속한다.</li>
<li>"/etc/nginx/sites-enabled/어떤파일"을 수정한다.</li>
</ol>

</div>
</div>
<div id="outline-container-org6d3006d" class="outline-5">
<h5 id="org6d3006d">(1) nginx에서 수행할 rails app지정</h5>
<div class="outline-text-5" id="text-org6d3006d">

<div id="org3b9528f" class="figure">
<p><img src="./img/nginxsettings.png" alt="nginxsettings.png" width="800px" />
</p>
<p><span class="figure-number">Figure 16: </span>nginxsettings1</p>
</div>

<div class="note" id="orgec44c29">
<p>
nginx가 시작되면 nginx는 sites<sub>enabled에</sub> 기술된 파일을 실행한다.  여기에 보면 새로만든 rails app의 이름은 server<sub>name으로</sub> 설정한다. 그리고 module로 끼워넣은 passenger WAS 를 켜서, server<sub>name을</sub> 참조할 수 있게 했다. 여기까지하고 cap production deploy할때, 에러가 발생하는지, web page연결이 잘 되는지 확인해본다. 우선 에러는 없고, web page연결은 잘 안될 것이다. route 설정이 안되어 있기 때문이다. 반면에 rails s에서 local에서는 잘동작하는 것을 볼 수 있다. server에서 
</p>

</div>
</div>
</div>
</div>
</div>
</div>
<div id="outline-container-org9f82f47" class="outline-2">
<h2 id="org9f82f47"><span class="section-number-2">4</span> client의 database.yml설정 (development)</h2>
<div class="outline-text-2" id="text-4">
<div class="note" id="org83f4f41">
<p>
capistrano를 사용해서 ci/cd로 client의 source를 server로 반영할 수 있었다. 하지만, db의 data는 동일하지 않다.
server에서 사용하는 db를 같이 사용할 수 있게 해자.
</p>

</div>

<div id="org8e309f1" class="figure">
<p><img src="./img/dbsettings1.png" alt="dbsettings1.png" width="800px" />
</p>
<p><span class="figure-number">Figure 17: </span>db settings1</p>
</div>
</div>
</div>

<div id="outline-container-org263273b" class="outline-2">
<h2 id="org263273b"><span class="section-number-2">5</span> 서버에 관해서 - testing</h2>
<div class="outline-text-2" id="text-5">
</div>
<div id="outline-container-org8d3528c" class="outline-3">
<h3 id="org8d3528c"><span class="section-number-3">5.1</span> nginx 기본 및 test</h3>
<div class="outline-text-3" id="text-5-1">
<div class="note" id="org48da69d">
<p>
nginx와 관련한 설정은 크게 보면 2가지가 있다.  첫째, /etc/nginx/nginx.conf가 있다. 이것은 nginx에 대한 설정이다. 둘째, /etc/nginx/site-enabled/설정 파일. 이것은 passenger와 연결되는 rails app에 대한 정보, domain주소와 같은 설정이 담겨져 있다. 이것이 nginx에 대한 모든 것이다.  
</p>

</div>
<div class="note" id="org78daec6">
<p>
rails app과 별도로 nginx 서버가 제대로 동작되는지 확인할 필요가 있다. 아래 설명처럼 해보자.
nginx가 설치 되어 있고 nginx가 구동되어 있다면? <i>etc/nginx/site-enabled</i> 에 있는 설정 파일이 실행된다. 그 설정 파일에 root를 기술하고, root아래에 index: index.html로 해주면 root폴더의  index.html이 화면에 보이게 된다. 이것을 통해서 nginx가 동작하고 있다는 것을 테스트할 수 있다.
</p>

</div>
<div class="tip" id="orge3ca1ef">
<p>
<i>etc/nginx/site-available</i> 에서 작성한 설정을 <i>etc/nginx/site-enabled</i> 에 link걸어서 사용한다. 아파치에서 사용하는 방식이다. 즉 server에 대한 설정을 available에서 하고, link걸어서 적용시킨다. 근데 나는 별 상관하지 않았다.
</p>

</div>
</div>
</div>
<div id="outline-container-org3560873" class="outline-3">
<h3 id="org3560873"><span class="section-number-3">5.2</span> nginx + passenger</h3>
<div class="outline-text-3" id="text-5-2">
<div class="note" id="org52a35f9">
<p>
passenger는 WAS다. 즉 rails를 구동 시키는 역할을 한다. ruby를 설정하고, ruby로 rails app을 실행시킨다고 보면 된다. local에서 rails s를 하면 puma라고 하는 was가 실행되는 것과 비슷하다.
이 passenger는 module형태로 제공이 된다. nginx를 기동하면 /etc/nginx/modules/passenger.so가 load된다. 하지만 중요한것은 passenger가 포함되던, nginx만 단독으로 하던간에 /etc/nginx/site-enabled/에 있는 설정이 실행된다는 것이다. 그 설정에서 passenger에 대한 설정을 추가할 뿐이다. 즉 ngixn +passenger가 잘 동작하는지 확인하기위해선, /etc/nginx/site-enabled/의 설정이 제대로 동작하는지 확인하면 된다. 그렇다고 해서 passenger의 설정파일이 없는 건 아니다. /etc/nginx/conf.d/mod-http-passenger.conf에서 passenger의 설정을 한다. 
</p>

</div>
</div>

<div id="outline-container-org3e41547" class="outline-4">
<h4 id="org3e41547">(8) web 관련 설정</h4>
<div class="outline-text-4" id="text-org3e41547">
</div>
<div id="outline-container-org96ea421" class="outline-5">
<h5 id="org96ea421"><i>etc/nginx/conf.d</i> - passenger설정</h5>
</div>

<div id="outline-container-orgd09a5ec" class="outline-5">
<h5 id="orgd09a5ec">/site-enabled/config - nginx 설정</h5>
<div class="outline-text-5" id="text-orgd09a5ec">
<div class="note" id="org7b8e96a">
<p>

</p>

</div>
</div>
</div>
</div>

<div id="outline-container-org9fce9e0" class="outline-4">
<h4 id="org9fce9e0">error처리 모음.</h4>
<div class="outline-text-4" id="text-org9fce9e0">
</div>
<div id="outline-container-org63de0b6" class="outline-5">
<h5 id="org63de0b6">nginx가 start되지 않고, passenger관련 에러 (/var/log폴더 삭제시)</h5>
<div class="outline-text-5" id="text-org63de0b6">
<div class="note" id="org1f281a7">
<p>
시스템을 확장한다거나, 데이터부족으로 /var/log/nginx 폴더가 삭제되었을때,  ec2를 다시 껏다 키면 아래와 같은 에러가 나타난다. nginx가 start되지도 않는다. 이런 경우에 /var/logn/nginx 폴더를 만들어 주면 된다.
</p>

</div>

<div id="org3ac8964" class="figure">
<p><img src="./img/error1.png" alt="error1.png" width="800px" />
</p>
<p><span class="figure-number">Figure 18: </span>error1</p>
</div>
</div>
</div>
<div id="outline-container-orgaea65df" class="outline-5">
<h5 id="orgaea65df">bundle에서 에러</h5>
<div class="outline-text-5" id="text-orgaea65df">
<div class="note" id="orgcb6799b">
<p>
bundle lock &#x2013;add-platform x86<sub>64</sub>-linux
</p>

</div>
</div>
</div>
<div id="outline-container-orge72cc18" class="outline-5">
<h5 id="orge72cc18">DB관련 권한 문제</h5>
<div class="outline-text-5" id="text-orge72cc18">
<div class="note" id="org022fd71">
<p>
우선 사용자가 사용할 수 있는 db여야 한다. 즉 mysql -udeploy로 접속해서 show databases;를 해서 db가 있는지 확인해야 한다. 그런 다음에 해당 db의 모든 권한을 줘야 한다. 예를 들어서 deploy란 사용자가 kwaterdb라는 db가 있다면,  다음 코드를 추가한다.
</p>

</div>
<div class="note" id="org51e1880">
<p>
GRANT ALL PRIVILEGES ON kwaterdb.* TO 'deploy'@'localhost';
GRANT ALL PRIVILEGES ON kwaterdb.* TO 'deploy'@'%';
FLUSH PRIVILEGES;
</p>

</div>
</div>
</div>
</div>
</div>
</div>

<div id="outline-container-orgff5079e" class="outline-2">
<h2 id="orgff5079e"><span class="section-number-2">6</span> log에 관해서</h2>
<div class="outline-text-2" id="text-6">
</div>
<div id="outline-container-orgb86700f" class="outline-3">
<h3 id="orgb86700f"><span class="section-number-3">6.1</span> rails log</h3>
<div class="outline-text-3" id="text-6-1">
<div class="note" id="org31234a1">
<p>
less /home/deploy/smartwatercare/current/log/production.log
</p>

</div>
</div>
</div>
<div id="outline-container-orgf8c11e2" class="outline-3">
<h3 id="orgf8c11e2"><span class="section-number-3">6.2</span> nginx &amp; passenger log</h3>
<div class="outline-text-3" id="text-6-2">
<div class="note" id="org7444730">
<p>
sudo less /var/log/nginx/error.log
</p>

</div>
</div>
</div>
</div>
</div>
<div id="postamble" class="status">
<p class="author">Author: Holy Frege</p>
<p class="date">Created: 2021-12-01 Wed 15:02</p>
<p class="validation"><a href="https://validator.w3.org/check?uri=referer">Validate</a></p>
</div>
</body>
</html>
